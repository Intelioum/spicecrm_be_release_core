/* * *******************************************************************************
* This file is part of SpiceCRM FulltextSearch. SpiceCRM FulltextSearch is an enhancement developed
* by aac services k.s.. All rights are (c) 2016 by aac services k.s.
*
* This Version of the SpiceCRM FulltextSearch is licensed software and may only be used in
* alignment with the License Agreement received with this Software.
* This Software is copyrighted and may not be further distributed without
* witten consent of aac services k.s.
*
* You can contact us at info@spicecrm.io
******************************************************************************* */

SpiceCRM.controller("GlobalFTSController",["$scope","GlobalFTSService",function(e,r){angular.extend(e,{globalFTSService:r,keyup:function(e){}}),e.$watch("globalFTSService.gloablSearchTerm",function(e,l){if((e||l)&&e!==l){r.getGlobalFTSSearchResults();var o=document.getElementById("query_string");o&&(o.value=e)}})}]),SpiceCRM.controller("GlobalFTSModuleItemController",["$scope","GlobalFTSService",function(e,l){angular.extend(e,{globalFTSService:l,setSearchModule:function(){this.globalFTSService.searchFiltermodule=this.menuItem,this.globalFTSService.getGlobalFTSModuleSearchResults()}})}]),SpiceCRM.directive("globalFtsModuleItem",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModuleItem.html",controller:"GlobalFTSModuleItemController",replace:!0,scope:{menuItem:"="}}}]),SpiceCRM.controller("GlobalFTSModulePanelController",["$scope","GlobalFTSService",function(e,l){angular.extend(e,{globalFTSService:l,loadMore:function(e){this.globalFTSService.getGlobalFTSMoreSearchResults(e)}})}]),SpiceCRM.directive("globalFtsModulePanel",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModulePanel.html",controller:"GlobalFTSModulePanelController",replace:!0,scope:{searchModule:"="}}}]),SpiceCRM.controller("GlobalFTSModulePanelHeaderController",["$scope","GlobalFTSService",function(e,l){angular.extend(e,{globalFTSService:l,getFieldStyle:function(e){return{width:e.width+"%"}}})}]),SpiceCRM.directive("globalFtsModulePanelHeader",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModuleHeader.html",controller:"GlobalFTSModulePanelHeaderController",replace:!0,scope:{searchModule:"="}}}]),SpiceCRM.controller("GlobalFTSModuleSearchItemController",["$scope","GlobalFTSService",function(e,l){angular.extend(e,{globalFTSService:l,getFieldStyle:function(e){return{width:e.width+"%"}},hasLink:function(l,e){var o=!1;return angular.forEach(this.globalFTSService.viewdefs[e._type],function(e){l.name.toUpperCase()==e.name.toUpperCase()&&e.link&&(o=!0)}),o},getLinkModule:function(l,e){if(e){var o=e._type;return angular.forEach(this.globalFTSService.viewdefs[e._type],function(e){l.name.toUpperCase()==e.name.toUpperCase()&&e.link&&e.linkmodule&&(o=e.linkmodule)}),o}},getLinkId:function(l,o){if(o){var r=o._id;return angular.forEach(this.globalFTSService.viewdefs[o._type],function(e){l.name.toUpperCase()==e.name.toUpperCase()&&e.link&&e.linkid&&(r=o._source[e.linkid.toLowerCase()])}),r}},getRecordValue:function(e,l){if(l&&l._source)return l._source[e.name.toLowerCase()]}})}]),SpiceCRM.directive("globalFtsModuleSearchItem",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModuleSearchItem.html",controller:"GlobalFTSModuleSearchItemController",replace:!0,scope:{searchModule:"=",searchRecord:"="}}}]),SpiceCRM.factory("GlobalFTSService",["$rootScope","$http","$q",function(l,e,o){var r={globalFTSSearchModules:[],viewdefs:{},gloablSearchTerm:"",globalSearchModules:[],globalSearchModuleLabels:[],globalSearchResults:{},searchFiltermodule:"all",getGlobalFTSSearchModules:function(){e({method:"GET",url:"KREST/fts/searchmodules"}).success(function(l){r.globalFTSSearchModules.push("all"),angular.forEach(l.modules,function(e){r.globalFTSSearchModules.push(e),r.globalSearchModules.push(e),r.viewdefs=l.viewdefs,r.globalSearchModuleLabels[e]=SUGAR.language.get("app_list_strings","moduleList")[e]}),r.globalSearchModuleLabels.all="All Modules",r.getGlobalFTSSearchResults()})},getGlobalFTSSearchResults:function(){"all"!==this.searchFiltermodule?this.getGlobalFTSModuleSearchResults():e({method:"GET",url:"KREST/fts/globalsearch/"+r.globalSearchModules.join()+(r.gloablSearchTerm?"/":"")+r.gloablSearchTerm}).success(function(e){r.globalSearchResults=e,l.$$phase||l.$apply()})},getGlobalFTSMoreSearchResults:function(l){e({method:"GET",url:"KREST/fts/globalsearch/"+l+(r.gloablSearchTerm?"/":"")+r.gloablSearchTerm+"?records=25&start="+r.globalSearchResults[l].hits.length}).success(function(e){r.globalSearchResults[l].hits=r.globalSearchResults[l].hits.concat(e[l].hits)})},getGlobalFTSModuleSearchResults:function(){"all"===this.searchFiltermodule?this.getGlobalFTSSearchResults():e({method:"GET",url:"KREST/fts/globalsearch/"+this.searchFiltermodule+(r.gloablSearchTerm?"/":"")+r.gloablSearchTerm+"?records=50&start=0"}).success(function(e){r.globalSearchResults=e,l.$$phase||l.$apply()})}};return r.gloablSearchTerm=document.getElementById("query_string").value,r.getGlobalFTSSearchModules(),r}]);